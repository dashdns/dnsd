name: Publish Helm chart to Docker Hub (OCI)

on:
  push:
    tags: ["v*"]

env:
  OCI_REGISTRY: oci://registry-1.docker.io
  DOCKERHUB_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}
  CHART_DIR: charts/dashdns
  CHART_REPO: dashdns

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Helm version
        run: helm version

      - name: Docker Hub login (Helm OCI)
        run: |
          helm registry login registry-1.docker.io \
            --username "${{ secrets.DOCKERHUB_USERNAME }}" \
            --password "${{secrets.DOCKERHUB_TOKEN}}"

      - name: Compute chart version from git tag
        id: ver
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Lint chart
        run: helm lint "${{ env.CHART_DIR }}"

      - name: Verify Chart.yaml version matches tag
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          CHART_VERSION="$(yq -r '.version' "${{ env.CHART_DIR }}/Chart.yaml")"
          if [ "$CHART_VERSION" != "${{ steps.ver.outputs.version }}" ]; then
            echo "Chart.yaml version ($CHART_VERSION) != git tag version (${{ steps.ver.outputs.version }})"
            exit 1
          fi

      - name: Package chart
        run: |
          mkdir -p dist
          helm package "${{ env.CHART_DIR }}" --destination dist

      - name: Push chart (tag release)
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          HELM_EXPERIMENTAL_OCI: "1"
        run: |
          CHART_TGZ="$(ls dist/*.tgz | head -n1)"
          helm push "$CHART_TGZ" "${{ env.OCI_REGISTRY }}/${{ env.DOCKERHUB_NAMESPACE }}"

      - name: (Optional) Push chart on main as edge
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Skipping main publish by default (avoid re-pushing same version)."